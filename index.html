<html xmlns:aad="http://www.w3.org/1999/xhtml">
<head>
    <link href="css/ui-lightness/jquery-ui-1.8.21.custom.css" rel="stylesheet" type="text/css" />
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <title>INFLAB01</title>
</head>

<body>
<div id="content" class="clearfix">
	<div id="mapArea"></div>
    <div id="controllers-analyser">
        <h2>Analyse</h2>
        <div class="controller">
            <div class="label">Pearsons nauwkeurigheid:</div>
            <div id="raster-size-val" class="value">10</div>
            <div class="slider" id="raster-size"></div>
        </div>
        <div class="controller">
            <div class="label">Zonegrootte:</div>
            <div id="zones-val" class="value">3</div>
            <div class="slider" id="zones"></div>
        </div>
        <div class="controller">
            <div class="label">Minimum correlatie:</div>
            <div id="min-correlation-val" class="value">0.5</div>
            <div class="slider" id="min-correlation"></div>
        </div>
        <div class="collection-selector">
            Datasets en attributen:
            <div>
                <select id="collections1" class="collections"><option value="">-</option></select>
                <select id="attributes1-1" class="attributes collections1"><option value="">-</option></select>
                <select id="attributes1-2" class="attributes collections1"><option value="">-</option></select>
                <select id="attributes1-3" class="attributes collections1"><option value="">-</option></select>
                <select id="attributes1-4" class="attributes collections1"><option value="">-</option></select>
                <select id="attributes1-5" class="attributes collections1"><option value="">-</option></select>
            </div>
            <div>
                <select id="collections2" class="collections"><option value="">-</option></select>
                <select id="attributes2-1" class="attributes collections2"><option value="">-</option></select>
                <select id="attributes2-2" class="attributes collections2"><option value="">-</option></select>
                <select id="attributes2-3" class="attributes collections2"><option value="">-</option></select>
                <select id="attributes2-4" class="attributes collections2"><option value="">-</option></select>
                <select id="attributes2-5" class="attributes collections2"><option value="">-</option></select>
            </div>
            <div>
                <select id="collections3" class="collections"><option value="">-</option></select>
                <select id="attributes3-1" class="attributes collections3"><option value="">-</option></select>
                <select id="attributes3-2" class="attributes collections3"><option value="">-</option></select>
                <select id="attributes3-3" class="attributes collections3"><option value="">-</option></select>
                <select id="attributes3-4" class="attributes collections3"><option value="">-</option></select>
                <select id="attributes3-5" class="attributes collections3"><option value="">-</option></select>
            </div>
        </div>
        <input type="button" id="start-analyzer" value="Analyseer">
        <input type="button" id="reset-analyzer" value="Reset map">
        <div id="associations-results"></div>
    </div>
    <div id="upload" class="clearfix">
        <h2>Nieuwe set uploaden</h2>
        <form enctype="multipart/form-data" action="scripts/upload-file.py" method="post">
            <div><label>Collectie naam:</label><input type="text" name="collection"></div>
            <div><label>Shp bestand:</label> <input type="file" name="shp"></div>
            <div><label>Dbf bestand:</label> <input type="file" name="dbf"></div>
            <div style="padding-top: 40px;"><input type=submit value="Uploaden"></div>
        </form>
    </div>
</div><!-- content -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="js/common.js"></script>
<script type="text/javascript">

var map;
var grid = Grid;

var data;

window.onload = function(){
    $(function() {
        $( "#raster-size" ).slider({
            value:10,
            min: 3,
            max: 50,
            step: 1,
            slide: function(event, ui){
                $( "#raster-size-val" ).html( ui.value );
            }
        });
        $( "#min-correlation" ).slider({
            value:0.5,
            min: 0,
            max: 1.0,
            step: 0.1,
            slide: function(event, ui){
                $( "#min-correlation-val" ).html( ui.value );
            }
        });
        $( "#zones" ).slider({
            value:3,
            min: 3,
            max: 50,
            step: 1,
            slide: function(event, ui){
                $( "#zones-val" ).html( ui.value );
                grid.columns = ui.value;
                grid.rows = ui.value;
            }
        });
    });
    var my_resolution = 100;
	var my_radius = 10;
	var my_opacity = 70;

	var myLatlng = new google.maps.LatLng(51.9209866008, 4.47188401315);
	var myOptions = {
	  zoom: 15,
	  center: myLatlng,
	  mapTypeId: google.maps.MapTypeId.ROADMAP,
	  disableDefaultUI: false,
	  scrollwheel: true,
	  draggable: true,
	  navigationControl: true,
	  mapTypeControl: false,
	  scaleControl: true,
	  disableDoubleClickZoom: false
	};
	map = new google.maps.Map(document.getElementById("mapArea"), myOptions);
    grid.map = map;

    var clearSelect = function(selectElement){
        $("."+($(selectElement).attr('id'))).find('option')
                .remove()
                .end()
                .append('<option value="">-</option>')
                .val('whatever');
    };

    // Adds an function to the analyze button to do something real.
    $("#start-analyzer").click(function() {
        grid.removeGrid();
        // The request url.
        var url = "scripts/analyze.py?bounds=" + map.getBounds() + "";

        // We store what data sets and attributes are selected
        var dataSets = [];
        var setAttributen = []; // Stores arrays with attributes

        // Check each data set select-field.
        $(".collection-selector").find(".collections option:selected").each(function(i, v){
            // Check if the value of a data set is not equal to '-'.
            if($(this).text() != "-") {
                // Check if the set is not selected before
                if(jQuery.inArray($(this).text(), dataSets) == -1) {
                    var selector = ".attributes." + $(this).parent().attr("id") + " option:selected";
                    var attributes = [];    // For a single data set

                    // Store each selected attribute
                    $(selector).each(function(j, w) {
                        if($(this).text() != "-") {
                            if(jQuery.inArray($(this).text(), attributes) == -1) {
                                attributes.push($(this).text());
                            }
                        }
                    });

                    // Store the data set and it attributes only if at least one attributes was selected, .
                    if($(attributes).size() > 0) {
                        dataSets.push($(this).text());
                        setAttributen.push(attributes);
                    }
                }
            }
        });

        // Kijk of er een geldige selectie van data sets (en attributen) is.
        if($(dataSets).size() > 0) {
            // Generate data set call
            var setCall = "{"
            $.each(dataSets, function(index, value) {
                var attrCal = "[";
                $.each(setAttributen[index], function (index, value) {
                    if(index != 0) {
                        attrCal += ", ";
                    }
                    attrCal += "\"" + value + "\"";
                });
                attrCal += "]";
                if(index != 0) {
                    setCall += ", "
                }
                setCall += "\"" + value + "\": " + attrCal;
            });
            setCall += "}";
            url += "&sets=" + setCall;

            url += "&zones=" + $("#zones-val").html();
            // Generate rasterSize option
            url += "&rasterSize=" + $("#raster-size-val").html();
            // Generate threshold option
            url += "&threshold=" + $("#min-correlation-val").html();

            $("#associations-results").html( '<img src="img/loading.gif" alt="loading">' );
            $.ajax({ url: url }).done(
                    function( response ) {
                        data = response;
                        var result = "<table cellspacing='15px'><thead><td>&nbsp;</td><td>Serie 1</td><td>Serie 2</td><td>Correlatie</td></thead>";
                        var zvc = null;

//                        var correlations = new Array();

                        $.each(data, function(i, item){
//                            correlations = fabricateCorrelation(item);
                            if (Math.abs(item["pearsons"]) > $("#min-correlation-val").html() ){


                                result += "<tr><td>" +
                                        "Set: <br>" +
                                        "Attribuut: <br>" +
                                        "Waarde: <br>" +
                                        "Met deze waarde: <br>" +
                                        "Totaal: " +
                                        "</td>" +
                                        "<td>" +
                                        item["set_a"]["set"]+"<br>" +
                                        item["set_a"]["attribute"]+"<br>" +
                                        item["set_a"]["value"] +"<br>" +
                                        item["set_a"]["amount-value"] +"<br>" +
                                        item["set_a"]["amount-total"] +
                                        "</td>" +
                                        "<td>" +
                                        item["set_b"]["set"]+"<br>" +
                                        item["set_b"]["attribute"]+"<br>" +
                                        item["set_b"]["value"] +"<br>" +
                                        item["set_b"]["amount-value"] +"<br>" +
                                        item["set_b"]["amount-total"] +
                                        "</td>" +
                                        "<td>"+item["pearsons"]+"</td></tr>";
                            }
                        });
                        zvc = countAvgDeviationViolation(data);
                        result += "</table>";
                        $("#associations-results").html( result );
                        grid.buildGrid();
                        for (var j = 0; j < zvc.length; j++){
                            if(zvc[j] > 3){
                                grid.tiles[j].fillOpacity = 0.5;
                            }
                            console.log(j + ": " + zvc[j]);
                        }
                    });
        } else {
            $("#associations-results").html("Geen geldige selectie van data set(s) en attributen.");
        }
    });

    $("#reset-analyzer").click(function() {
        grid.removeGrid();
        $("#associations-results").html('');
    });

    $.ajax({ url: "scripts/find_collections.py" }).done(
            function( msg ) {
                var options = $("select.collections");
                var coll_array = eval(msg);
                for (var i = 0; i < coll_array.length; i++) {
                    options.append($("<option />").val(coll_array[i]).text(coll_array[i]));
                }
                $(".collections").change(function(){
                    if ($(this).val() != ""){
                        var selector = this;
	                    var set = $("option:selected", this).text();
                        $.ajax({ url: "scripts/load_attributes.py?set="+set }).done(
                                function( response ){
                                    var att_array = eval(response);
                                    if (att_array == undefined ){
                                        clearSelect(selector);
                                    } else {
                                        clearSelect(selector);
                                        var selects = $("."+($(selector).attr("id")));
                                        for (var i = 0; i < att_array.length; i++) {
                                            selects.append($("<option />").val(att_array[i]).text(att_array[i]));
                                        }
                                    }

                                }
                        );
	                } else {
	                	clearSelect(this);
	                }
	            });
//                $('#collections1 :nth-child(2)').attr('selected', 'selected')
            });

};

</script>
</body>
</html>
